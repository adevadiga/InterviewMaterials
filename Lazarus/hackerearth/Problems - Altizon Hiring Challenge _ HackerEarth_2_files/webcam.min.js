// WebcamJS v1.0 - http://github.com/jhuckaby/webcamjs - MIT Licensed
(function(a){var b={version:"1.0.0",protocol:location.protocol.match(/https/i)?"https":"http",swfURL:"",loaded:!1,live:!1,userMedia:!0,params:{width:0,height:0,dest_width:0,dest_height:0,image_format:"jpeg",jpeg_quality:90,force_flash:!1},hooks:{load:null,live:null,uploadcomplete:null,uploadprogress:null,error:function(a){alert("Webcam.js Error: "+a)}},init:function(){navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,a.URL=a.URL||a.webkitURL||a.mozURL||a.msURL,this.userMedia=this.userMedia&&!!navigator.getUserMedia&&!!a.URL,navigator.userAgent.match(/Firefox\D+(\d+)/)&&parseInt(RegExp.$1,10)<21&&(this.userMedia=null)},attach:function(c){typeof c=="string"&&(c=document.getElementById(c)||document.querySelector(c));if(!c)return this.dispatch("error","Could not locate DOM element to attach to.");this.container=c,c.innerHTML="";var d=document.createElement("div");c.appendChild(d),this.peg=d,this.params.width||(this.params.width=c.offsetWidth),this.params.height||(this.params.height=c.offsetHeight),this.params.dest_width||(this.params.dest_width=this.params.width),this.params.dest_height||(this.params.dest_height=this.params.height),this.params.force_flash&&(this.userMedia=null);var f=this.params.width/this.params.dest_width,g=this.params.height/this.params.dest_height;if(this.userMedia){var h=document.createElement("video");h.setAttribute("autoplay","autoplay"),h.style.width=""+this.params.dest_width+"px",h.style.height=""+this.params.dest_height+"px";if(f!=1||g!=1)c.style.overflow="hidden",h.style.webkitTransformOrigin="0px 0px",h.style.mozTransformOrigin="0px 0px",h.style.msTransformOrigin="0px 0px",h.style.oTransformOrigin="0px 0px",h.style.transformOrigin="0px 0px",h.style.webkitTransform="scaleX("+f+") scaleY("+g+")",h.style.mozTransform="scaleX("+f+") scaleY("+g+")",h.style.msTransform="scaleX("+f+") scaleY("+g+")",h.style.oTransform="scaleX("+f+") scaleY("+g+")",h.style.transform="scaleX("+f+") scaleY("+g+")";c.appendChild(h),this.video=h;var i=this;navigator.getUserMedia({audio:!1,video:!0},function(c){h.src=a.URL.createObjectURL(c)||c,b.stream=c,b.loaded=!0,b.live=!0,b.dispatch("load"),b.dispatch("live")},function(a){return i.dispatch("error","Could not access webcam.")})}else{var j=document.createElement("div");j.innerHTML=this.getSWFHTML(),c.appendChild(j)}if(this.params.crop_width&&this.params.crop_height){var k=Math.floor(this.params.crop_width*f),l=Math.floor(this.params.crop_height*g);c.style.width=""+k+"px",c.style.height=""+l+"px",c.style.overflow="hidden",c.scrollLeft=Math.floor(this.params.width/2-k/2),c.scrollTop=Math.floor(this.params.height/2-l/2)}else c.style.width=""+this.params.width+"px",c.style.height=""+this.params.height+"px"},reset:function(){this.preview_active&&this.unfreeze();if(this.userMedia){try{this.stream.stop()}catch(a){}delete this.stream,delete this.video}this.container.innerHTML="",delete this.container,this.loaded=!1,this.live=!1},set:function(){if(arguments.length==1)for(var a in arguments[0])this.params[a]=arguments[0][a];else this.params[arguments[0]]=arguments[1]},on:function(a,b){a=a.replace(/^on/i,"").toLowerCase();if(typeof this.hooks[a]=="undefined")throw"Event type not supported: "+a;this.hooks[a]=b},dispatch:function(){var b=arguments[0].replace(/^on/i,"").toLowerCase(),c=Array.prototype.slice.call(arguments,1);return this.hooks[b]?(typeof this.hooks[b]=="function"?this.hooks[b].apply(this,c):typeof this.hooks[b]=="array"?this.hooks[b][0][this.hooks[b][1]].apply(this.hooks[b][0],c):a[this.hooks[b]]&&a[this.hooks[b]].apply(a,c),!0):!1},setSWFLocation:function(a){this.swfURL=a},getSWFHTML:function(){var b="";if(location.protocol.match(/file/))return'<h1 style="color:red">Sorry, the Webcam.js Flash fallback does not work from local disk.  Please upload it to a web server first.</h1>';if(!this.swfURL){var c="",d=document.getElementsByTagName("script");for(var f=0,g=d.length;f<g;f++){var h=d[f].getAttribute("src");h&&h.match(/\/webcam(\.min)?\.js/)&&(c=h.replace(/\/webcam(\.min)?\.js.*$/,""),f=g)}c?this.swfURL=c+"/webcam.swf":this.swfURL="webcam.swf"}a.localStorage&&!localStorage.getItem("visited")&&(this.params.new_user=1,localStorage.setItem("visited",1));var i="";for(var j in this.params)i&&(i+="&"),i+=j+"="+escape(this.params[j]);return b+='<object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" type="application/x-shockwave-flash" codebase="'+this.protocol+'://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=9,0,0,0" width="'+this.params.width+'" height="'+this.params.height+'" id="webcam_movie_obj" align="middle"><param name="wmode" value="opaque" /><param name="allowScriptAccess" value="always" /><param name="allowFullScreen" value="false" /><param name="movie" value="'+this.swfURL+'" /><param name="loop" value="false" /><param name="menu" value="false" /><param name="quality" value="best" /><param name="bgcolor" value="#ffffff" /><param name="flashvars" value="'+i+'"/><embed id="webcam_movie_embed" src="'+this.swfURL+'" wmode="opaque" loop="false" menu="false" quality="best" bgcolor="#ffffff" width="'+this.params.width+'" height="'+this.params.height+'" name="webcam_movie_embed" align="middle" allowScriptAccess="always" allowFullScreen="false" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="'+i+'"></embed></object>',b},getMovie:function(){if(!this.loaded)return this.dispatch("error","Flash Movie is not loaded yet");var a=document.getElementById("webcam_movie_obj");if(!a||!a._snap)a=document.getElementById("webcam_movie_embed");return a||this.dispatch("error","Cannot locate Flash movie in DOM"),a},freeze:function(){var a=this,b=this.params;this.preview_active&&this.unfreeze();var c=this.params.width/this.params.dest_width,d=this.params.height/this.params.dest_height,e=b.crop_width||b.dest_width,f=b.crop_height||b.dest_height,g=document.createElement("canvas");g.width=e,g.height=f;var h=g.getContext("2d");this.preview_canvas=g,this.preview_context=h;if(c!=1||d!=1)g.style.webkitTransformOrigin="0px 0px",g.style.mozTransformOrigin="0px 0px",g.style.msTransformOrigin="0px 0px",g.style.oTransformOrigin="0px 0px",g.style.transformOrigin="0px 0px",g.style.webkitTransform="scaleX("+c+") scaleY("+d+")",g.style.mozTransform="scaleX("+c+") scaleY("+d+")",g.style.msTransform="scaleX("+c+") scaleY("+d+")",g.style.oTransform="scaleX("+c+") scaleY("+d+")",g.style.transform="scaleX("+c+") scaleY("+d+")";this.snap(function(){g.style.position="relative",g.style.left=""+a.container.scrollLeft+"px",g.style.top=""+a.container.scrollTop+"px",a.container.insertBefore(g,a.peg),a.container.style.overflow="hidden",a.preview_active=!0},g)},unfreeze:function(){this.preview_active&&(this.container.removeChild(this.preview_canvas),delete this.preview_context,delete this.preview_canvas,this.preview_active=!1)},savePreview:function(a,b){var c=this.params,d=this.preview_canvas,e=this.preview_context;if(b){var f=b.getContext("2d");f.drawImage(d,0,0)}a(b?null:d.toDataURL("image/"+c.image_format,c.jpeg_quality/100),d,e),this.unfreeze()},snap:function(a,b){var c=this,d=this.params;if(!this.loaded)return this.dispatch("error","Webcam is not loaded yet");if(!this.live)return this.dispatch("error","Webcam is not live yet");if(!a)return this.dispatch("error","Please provide a callback function or canvas to snap()");if(this.preview_active)return this.savePreview(a,b),null;var e=document.createElement("canvas");e.width=this.params.dest_width,e.height=this.params.dest_height;var f=e.getContext("2d"),g=function(){this.src&&this.width&&this.height&&f.drawImage(this,0,0,d.dest_width,d.dest_height);if(d.crop_width&&d.crop_height){var c=document.createElement("canvas");c.width=d.crop_width,c.height=d.crop_height;var g=c.getContext("2d");g.drawImage(e,Math.floor(d.dest_width/2-d.crop_width/2),Math.floor(d.dest_height/2-d.crop_height/2),d.crop_width,d.crop_height,0,0,d.crop_width,d.crop_height),f=g,e=c}if(b){var h=b.getContext("2d");h.drawImage(e,0,0)}a(b?null:e.toDataURL("image/"+d.image_format,d.jpeg_quality/100),e,f)};if(this.userMedia)f.drawImage(this.video,0,0,this.params.dest_width,this.params.dest_height),g();else{var h=this.getMovie()._snap(),i=new Image;i.onload=g,i.src="data:image/"+this.params.image_format+";base64,"+h}return null},configure:function(a){a||(a="camera"),this.getMovie()._configure(a)},flashNotify:function(a,b){switch(a){case"flashLoadComplete":this.loaded=!0,this.dispatch("load");break;case"cameraLive":this.live=!0,this.dispatch("live");break;case"error":this.dispatch("error",b);break;default:}},b64ToUint6:function(a){return a>64&&a<91?a-65:a>96&&a<123?a-71:a>47&&a<58?a+4:a===43?62:a===47?63:0},base64DecToArr:function(a,b){var c=a.replace(/[^A-Za-z0-9\+\/]/g,""),d=c.length,e=b?Math.ceil((d*3+1>>2)/b)*b:d*3+1>>2,f=new Uint8Array(e);for(var g,h,i=0,j=0,k=0;k<d;k++){h=k&3,i|=this.b64ToUint6(c.charCodeAt(k))<<18-6*h;if(h===3||d-k===1){for(g=0;g<3&&j<e;g++,j++)f[j]=i>>>(16>>>g&24)&255;i=0}}return f},upload:function(a,c,d){d&&b.on("uploadComplete",d);var e="webcam",f="";if(!a.match(/^data\:image\/(\w+)/))throw"Cannot locate image format in Data URI";f=RegExp.$1;var g=a.replace(/^data\:image\/\w+\;base64\,/,""),h=new XMLHttpRequest;h.open("POST",c,!0),h.upload&&h.upload.addEventListener&&h.upload.addEventListener("progress",function(a){if(a.lengthComputable){var c=a.loaded/a.total;b.dispatch("uploadProgress",c,a)}},!1),h.onload=function(){b.dispatch("uploadComplete",h.status,h.responseText,h.statusText)};var i=new Blob([this.base64DecToArr(g)],{type:"image/"+f}),j=new FormData;j.append(e,i,e+"."+f.replace(/e/,"")),h.send(j)}};b.init(),typeof define=="function"&&define.amd?define(function(){return b}):typeof module=="object"&&module.exports?module.exports=b:a.Webcam=b})(window);