// Global variable for the test timer
function leadingZero(a){return a<10?"0"+a:+a}function timeHandler(){this.hElem=$("#hours"),this.mElem=$("#mins"),this.sElem=$("#secs"),this.updateTime=function(a){this.hours=Math.floor(a/3600),a-=this.hours*3600,this.mins=Math.floor(a/60),a-=this.mins*60,this.secs=a},this_ctx=this,eventStarted=$(".timer").attr("started"),eventStarted=="False"?this.eventStarted=!1:this.eventStarted=!0;var a=Number($(".timer").attr("time"));this.updateTime(a),this.mins>20?syncTime=13:syncTime=Math.floor(this.mins/2)-2,msyncTime=syncTime*60*1e3,this.setTime=function(){this.hElem.html(leadingZero(this.hours)),this.mElem.html(leadingZero(this.mins)),this.sElem.html(leadingZero(this.secs))},this.updateTimer=function(){var b=Number($("#hours").html()),c=Number($("#mins").html()),d=Number($("#secs").html());d-=1,d==-1&&(c-=1,d=59,c==-1&&(b-=1,c=59,b==-1&&(b=0,c=0,d=0))),this.hours=b,this.mins=c,this.secs=d,$("#hours").html(leadingZero(this.hours)),$("#mins").html(leadingZero(this.mins)),$("#secs").html(leadingZero(this.secs)),b==0&&c==5&&d==0&&addAlert("Test is about to finish in 5 mins");if(b==0&&c==0&&d==0){var e=$(".timer").attr("end-test");$.ajax({type:"POST",url:e,dataType:"json",success:function(b){b["status"]=="OK"&&(b.ended?(clearInterval(testIntervalTimer),clearInterval(syncIntervalTimer),alert("The time has completed!"),CLOSE_BROWSER=!0,window.location=$(".timer").attr("test-completed")):(b.alert_message&&addAlert(b.alert_message),a=b.left,this_ctx.updateTime(a),$("#hours").html(leadingZero(this_ctx.hours)),$("#mins").html(leadingZero(this_ctx.mins)),$("#secs").html(leadingZero(this_ctx.secs))))}})}},this.syncTimer=function(){var b=$(".timer").attr("end-test");$.ajax({type:"POST",url:b,dataType:"json",success:function(b){b["status"]=="OK"&&(b.ended?(alert("The time has completed!"),CLOSE_BROWSER=!0,window.location=$(".timer").attr("test-completed")):(b.alert_message&&addAlert(b.alert_message),a=b.left,this_ctx.updateTime(a),$("#hours").html(leadingZero(this_ctx.hours)),$("#mins").html(leadingZero(this_ctx.mins)),$("#secs").html(leadingZero(this_ctx.secs))))}})},this.startTimer=function(){this.eventStarted&&(testIntervalTimer=setInterval(this.updateTimer,1e3))},this.startSync=function(){this.eventStarted&&(syncIntervalTimer=setInterval(this_ctx.syncTimer,12e4))},this.init=function(){this.setTime(),this.startTimer(),setTimeout(this.startSync,msyncTime)}}var testIntervalTimer=0,syncIntervalTimer=0,CLOSE_BROWSER=!1,this_ctx,syncTime,msyncTime;$(document).ready(function(){$("#end-test-click").live("click",function(){CLOSE_BROWSER=!0}),$(".test-snapshot-button").live("click",function(a){a.preventDefault(),confirm("This test requires webcam access. Give webcam permission.")?initWebcam():($("#webcam-error").text("You can not take test without giving access to webcam."),$("#webcam-error").show())});var a=$(".timer");if(a.length>0){var b=new timeHandler;b.init();var c=a.attr("started");c!=="False"&&(window.onbeforeunload=function(a){if(!CLOSE_BROWSER){var b="Are you sure you want to leave?";return typeof a=="undefined"&&(a=window.event),a&&(a.returnValue=b),b}})}});